<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新聞輪播</title>
  <style>
    body {
      /* border: 2px solid rgb(87, 8, 185); */
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      background-color: #f0f0f0;
      font-family: Arial, sans-serif;
    }

    #home_newsSection {
      display: flex;
      flex-direction: column;
    }

    .carousel-container {
      /* border: 2px solid rgb(87, 8, 185); */
      height: 67vh;
      position: relative;
      max-width: 50vw;
      margin: 20px auto;
      overflow: hidden;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .carousel-inner {
      /* border: 2px solid rgb(218, 146, 13); */
      display: flex;
      transition: transform 0.5s ease-in-out;
    }

    .carousel-slide {
      /* border: 5px solid rgb(40, 218, 13); */
      min-width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .carousel-slide img {
      /* border: 5px solid rgb(44, 13, 218); */
      padding-top: 2vh;
      width: 100%;
      height: 55vh;
      object-fit: contain;
      border-radius: 10px;
    }

    .carousel-slide h2 {
      /* border: 2px solid rgb(127, 215, 11); */
      display: flex;
      align-items: center;
      justify-content: center;
      height: 1vh;
      padding: 1.5vh;
      max-width: 100%;
      margin-top: 1vh;
    }

    .carousel-slide h2 a {
      color: black;
      text-decoration: none;
    }

    .carousel-slide h2 a:hover {
      text-decoration: underline;
    }

    .carousel-dots-container {
      /* border: 2px solid red; */
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      bottom: 7vh;
      left: 43vw;
      width: 13%;
    }

    .prev,
    .next {
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.5vw;
      cursor: pointer;
    }

    .prev:hover,
    .next:hover {
      color: rgba(0, 0, 0, 0.8);
    }

    .carousel-dots {
      display: flex;
      justify-content: center;
      flex-grow: 1;
    }

    .carousel-dots span {
      cursor: pointer;
      height: 1.4vh;
      width: 0.7vw;
      margin: 0.5vw;
      background-color: #8f8b8b;
      border-radius: 50%;
      display: inline-block;
      transition: background-color 0.3s ease;
    }

    .carousel-dots span.active {
      background-color: #000000;
    }
  </style>
</head>

<body>
  <section id="home_newsSection">
    <div class="carousel-container">
      <div class="carousel-inner" id="carousel-inner">
      </div>
    </div>
    <div class="carousel-dots-container">
      <a class="prev" onclick="changeSlide(-1)">&#10094;</a>
      <div class="carousel-dots" id="carousel-dots"></div>
      <a class="next" onclick="changeSlide(1)">&#10095;</a>
    </div>
  </section>

  <script>
    let slideIndex = 1;
    let totalSlides;
    const apiKey = 'ff4b3af578664a56b7c10de98a705f8b';
    const query = '出國 AND 機票 AND 旅遊';
    const apiUrl = `https://newsapi.org/v2/everything?q=${query}&apiKey=${apiKey}&language=zh`;
    const carouselInner = document.getElementById('carousel-inner');
    const carouselDots = document.getElementById('carousel-dots');
    let slides;

    // 使用 fetch 獲取新聞資料
    function homeNews() {
      fetch(apiUrl)
        .then(response => response.json())
        .then(data => {
          carouselInner.innerHTML = '';
          carouselDots.innerHTML = '';
          console.log(data.articles)  // 檢查 API 回應內容

          let validArticles = 0;

          data.articles.some((article, index) => {
            if (!article.urlToImage || !article.title || article.urlToImage.includes("yahoo_default_logo")) {
              return false; // 跳過無效新聞
            }

            validArticles++;

            const slideElement = document.createElement('div');
            slideElement.classList.add('carousel-slide');
            slideElement.innerHTML = `
          <img src="${article.urlToImage}" alt="新聞圖像">
          <h2><a href="${article.url}" target="_blank">${article.title}</a></h2>
        `;
            carouselInner.appendChild(slideElement);

            // 停止抓取超過6則新聞
            return validArticles === 6;
          });

          slides = document.getElementsByClassName('carousel-slide');
          totalSlides = slides.length;

          // 複製第一張和最後一張
          const firstClone = slides[0].cloneNode(true);
          const lastClone = slides[totalSlides - 1].cloneNode(true);

          firstClone.id = 'first-clone';
          lastClone.id = 'last-clone';

          carouselInner.appendChild(firstClone);
          carouselInner.insertBefore(lastClone, slides[0]);

          totalSlides = slides.length;

          // 生成對應幻燈片的圓點
          for (let i = 0; i < totalSlides - 2; i++) {
            const dot = document.createElement('span');
            dot.setAttribute('onclick', `goToSlide(${i + 1})`);
            if (i === 0) {
              dot.classList.add('active');  // 第一個圓點活動狀態
            }
            carouselDots.appendChild(dot);
          }

          if (validArticles > 0) {
            startCarousel();  // 啟動輪播
          }
        })
        .catch(error => {
          console.error('無法取得新聞資料:', error);
        });
    }

    setInterval(homeNews, 600000);  // 600,000 毫秒 = 10 分鐘

    homeNews();

    // 啟動輪播的函數
    function startCarousel() {
      setInterval(() => changeSlide(1), 5000);
    }

    function changeSlide(n) {
      if (n > 0 && slideIndex === totalSlides - 1) {
        // 如果是向前滑動並且到了最後一個幻燈片
        slideIndex = 1;  // 跳回第一張真實的幻燈片
        carouselInner.style.transition = 'none';
        carouselInner.style.transform = `translateX(-${slideIndex * 100}%)`;
        setTimeout(() => {
          carouselInner.style.transition = 'transform 0.5s ease-in-out';
          slideIndex++;  // 此處需要立即更新 slideIndex 才能正確觸發下一個點擊的行為
          carouselInner.style.transform = `translateX(-${slideIndex * 100}%)`;
          updateDots(); // 確保圓點在正確位置後立即更新
        }, 50);
      } else if (n < 0 && slideIndex === 0) {
        // 如果是向後滑動並且到了第一個克隆的幻燈片
        slideIndex = totalSlides - 2;  // 跳回最後一張真實的幻燈片
        carouselInner.style.transition = 'none';
        carouselInner.style.transform = `translateX(-${slideIndex * 100}%)`;
        setTimeout(() => {
          carouselInner.style.transition = 'transform 0.5s ease-in-out';
          slideIndex--;
          carouselInner.style.transform = `translateX(-${slideIndex * 100}%)`;
          updateDots();
        }, 50);
      } else {
        // 正常滑動
        slideIndex += n;
        carouselInner.style.transform = `translateX(-${slideIndex * 100}%)`;
        updateDots();  // 正常情況下，立即更新圓點狀態
      }
    }

    function goToSlide(index) {
      slideIndex = index;
      carouselInner.style.transform = `translateX(-${slideIndex * 100}%)`;
      updateDots();
    }

    function updateDots() {
      const dots = carouselDots.getElementsByTagName('span');

      // 計算正確的 dotIndex，只針對真實的幻燈片
      let dotIndex = slideIndex - 1;
      if (slideIndex === 0) {
        dotIndex = totalSlides - 3;  // 如果在最後一個對應最後一個真實幻燈片
      } else if (slideIndex === totalSlides - 1) {
        dotIndex = 0;  // 如果在第一個克隆，對應第一個真實幻燈片
      }

      // 重置所有圓點的 active 狀態
      for (let i = 0; i < dots.length; i++) {
        dots[i].classList.remove('active');
      }

      // 設置當前活動圓點
      if (dots[dotIndex]) {
        dots[dotIndex].classList.add('active');
      }
    }
  </script>
</body>

</html>