<!DOCTYPE html>
<html lang="zh-tw">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>訂購頁</title>

    <link rel="stylesheet" href="./Order.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- 社群媒體的iconnnnnnnnnnnn -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet" />

</head>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var modal = document.getElementById("myModal");
        var btn = document.getElementById("view_details");
        var span = document.getElementsByClassName("close")[0];
        btn.onclick = function () {
            modal.style.display = "block";
        }
        span.onclick = function () {
            modal.style.display = "none";
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    });


</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const nextStepButton = document.getElementById('next_step');
    let passengerId;
    let orderId;

    if (nextStepButton) {
        nextStepButton.addEventListener('click', function (event) {
            event.preventDefault();

            // 初始化聯絡人資料
            const contactData = {
                contactName: document.getElementById('contact_name').value,
                contactPhone: document.getElementById('contact_phone').value,
                contactEmail: document.getElementById('contact_email').value,
            };

            // 初始化乘客資料
            const passengerData = {
                lastName: document.getElementById('lastname').value,
                firstName: document.getElementById('firstname').value,
                gender: document.getElementById('gender').value,
                birthday: document.getElementById('dob').value,
                country: document.getElementById('country').value,
                idType: document.getElementById('idtype').value,
                idNumber: document.getElementById('idnumber').value,
                idDate: document.getElementById('dop').value,
                // contactId 會在聯絡人成功提交後設置
            };

            // 提交聯絡人資料
            fetch('/orders/createContact', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(contactData)
            })
            .then(contactResponse => {
                if (!contactResponse.ok) {
                    throw new Error('Contact submission failed: ' + contactResponse.statusText);
                }
                return contactResponse.json();
            })
            .then(contactData => {
                console.log('聯絡人已成功提交:', contactData);
                passengerData.contactId = contactData.cid; // 在這裡設置聯絡人 ID

                return fetch('/passenger/createpassenger', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(passengerData)
                });
            })
            .then(passengerResponse => {
                if (!passengerResponse.ok) {
                    throw new Error('Passenger submission failed: ' + passengerResponse.statusText);
                }
                return passengerResponse.json();
            })
            .then(passengerData => {
                console.log('乘客已成功提交:', passengerData);
                passengerId = passengerData.pid;

                // 構建訂單資料
                const orderData = {
                    orderNumber: 'ORDER-' + new Date().getTime(),
                    contact: { 
                        CId: passengerData.contactId // 確保這裡的值是有效的
                    },
                };

                console.log('訂單資料:', JSON.stringify(orderData, null, 2));

                return fetch('/orders/createOrder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(orderData)
                });
            })
            .then(orderResponse => {
                if (!orderResponse.ok) {
                    throw new Error('訂單提交失敗: ' + orderResponse.statusText);
                }
                return orderResponse.json();
            })
            .then(orderData => {
                console.log('訂單提交成功', orderData);
                orderId = orderData.oid;

                // 收集行李資料
                const luggageData = [
                    {
                        tripType: "OUTBOUND",
                        addLuggage: document.getElementById('add_luggage_1').value, // 例如: 取得行李選項
                        lgprice: getLuggagePrice(document.getElementById('add_luggage_1').value),
                        passengerId: passengerId, // 設置乘客 ID
                        orderId: orderId // 設置訂單 ID
                    },
                    {
                        tripType: "RETURN",
                        addLuggage: document.getElementById('add_returnluggage_2').value,
                        lgprice: getLuggagePrice(document.getElementById('add_returnluggage_2').value),
                        passengerId: passengerId,
                        orderId: orderId
                    }
                ];

                // 提交行李數據
                return fetch('/luggage/createluggages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(luggageData)
                });
            })
            .then(luggageResponse => {
                if (!luggageResponse.ok) {
                    throw new Error('Luggage submission failed: ' + luggageResponse.statusText);
                }
                return luggageResponse.json();
            })
            .then(luggageData => {
                console.log('行李資訊已成功更新:', luggageData);
                alert('所有資料已成功提交');
            })
            .catch(error => {
                console.log('資料提交過程中出現問題:', error);
                alert('提交失敗: ' + error.message);
            });
        });
    } else {
        console.error('next_step not found.');
    }

    // 獲取行李價格的函數
    function getLuggagePrice(optionValue) {
        switch (optionValue) {
            case 'non_lg':
                return 0;
            case 'one_lg':
                return 1224;
            case 'two_lg':
                return 1698;
            case 'three_lg':
                return 2171;
            default:
                return 0;
        }
    }
});
        
</script>


<body>
    <header style="border-bottom: 10px solid #F4CFE0">
        <nav id="header">
            <div class="header_logo"><a href=""><img src="/picture/logo.png"></a></div>
            <ul class="header_nav_links">
                <li class="header_link"><a href="#"><img src="/picture/icon_logIn.png"></a></li>
                <li class="header_link"><a href="#"><img src="/picture/icon_Forum.png" class="nav_icon"></a></li>
            </ul>
        </nav>
    </header>

    <div style="margin: 2%  5% 0 5% ; text-align: center; font-size: 20px;">
        <ul>
            <li>
                <div class="process_info_bg">填寫旅客資訊</div>
            </li>
            <li><span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward_ios</span></li>

            <li>
                <div class="process_bg">會員登入/註冊</div>
            </li>
            <li><span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward_ios</span></li>
            <li>
                <div class="process_bg">訂單成立</div>
            </li>
            <li><span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward_ios</span></li>
            <li>
                <div class="process_bg">選擇付款方式</div>
            </li>
            <li><span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward_ios</span></li>
            <li>
                <div class="process_bg">結帳</div>
            </li>
            <li><span class="material-symbols-outlined" style="vertical-align: middle;">arrow_forward_ios</span></li>
            <li>
                <div class="process_bg">完成訂購</div>
            </li>
        </ul>
    </div>
    <div class="container_bg row">
        <div class="col_left">
            <h5 style="margin-left: 10%; font-size: 24px;">東京之旅</h5>
            <div class="container" style="width: 80%; padding: 20px; font-size: 18px;">行程總覽
                <br>
                <hr style="border: none; border-top: 5px solid #1f0737;">
                <div class="box">
                    <div style="font-weight: bold;">台北->東京</div>
                    <div style="display: flex;padding:20px 0">
                        <div
                            style="background-color: #431274; color:white; margin: 0 5px; padding: 0 10px; border-radius: 5px;">
                            去程</div>
                        <div>9月21日 週六 ｜</div>
                        <div>所需時間: 3小時25分</div>
                    </div>
                    <div style="display: flex; gap: 30px;">
                        <div style="display:grid; justify-items: center;gap: 20px;">
                            <div>15:30</div>
                            <div>台灣虎航</div>
                            <div>19:55</div>
                        </div>
                        <div style="display:grid; justify-content:center; gap: 20px;">
                            <span class="material-symbols-outlined">more_vert</span>
                            <span class="material-symbols-outlined">more_vert</span>
                            <span class="material-symbols-outlined">more_vert</span>
                        </div>
                        <div style="display: grid; justify-content: center;gap: 20px;">
                            <div>TPE台北 桃園機場T1</div>
                            <div>IT700 經濟艙</div>
                            <div>NRT東京 成田國際機場T2</div>
                        </div>

                    </div>
                </div>
                <hr style="border: none; border-top: 5px dashed #1f0737;">
                <div class="box">
                    <div style="font-weight: bold;">東京->台北</div>
                    <div style="display: flex;padding:20px 0">
                        <div
                            style="background-color: #431274; color:white;margin: 0 5px; padding: 0 10px; border-radius: 5px;">
                            回程</div>
                        <div>9月26日 週四 ｜</div>
                        <div>所需時間: 3小時40分</div>
                    </div>
                    <div style="display: flex; gap: 30px;">
                        <div style="display:grid; justify-items: center;gap: 20px;">
                            <div>20:45</div>
                            <div>台灣虎航</div>
                            <div>23:25</div>
                        </div>
                        <div style="display:grid; justify-content:center;gap: 20px;">
                            <span class="material-symbols-outlined">more_vert</span>
                            <span class="material-symbols-outlined">more_vert</span>
                            <span class="material-symbols-outlined">more_vert</span>
                        </div>
                        <div style="display: grid; justify-content: center;gap: 20px;">
                            <div>NRT東京 成田國際機場T2</div>
                            <div>IT701 經濟艙</div>
                            <div>TPE台北 桃園機場T1</div>
                        </div>

                    </div>
                </div>
            </div>


            <h5 style="margin-left: 10%; font-size: larger;">您的機票</h5>
            <div class="container_notice">
                <div style="display: flex; width: 50%; justify-content: start; ">
                    <div style="margin: 10%;"><span class="material-symbols-outlined"
                            style="font-size: 68px;">campaign</span></div>
                    <div>
                        <h3>出票時間</h3>
                        <p>付款成功後，<br>
                            將於4天內出票。</p>
                    </div>
                </div>

                <div style="display: flex; width: 50%;">
                    <div style="margin: 10%;"><span class="material-symbols-outlined"
                            style="font-size: 68px;">flight_takeoff</span></div>
                    <div>
                        <h3>行前須知</h3>
                        <p>依序使用機票<br>
                            <a href="#" id="view_details">查看詳情</a>
                        </p>
                    </div>
                </div>

            </div>

            <div id="myModal" class="modal">
                <div class="modal_content">
                    <div style="padding-bottom: 10px;"><span class="close">&times;</span></div>
                    <div style="background-color:#1f0737; color:white; padding: 0;">
                        <h3>行前須知</h3>
                    </div>

                    <div style="background-color: white; opacity: 80%; padding: 0 auto;">
                        <div>
                            <h3>出票時間</h3>
                            <p>付款成功後，將於4天內出票。</p>
                        </div>

                        <div>
                            <h3>依序使用機票</h3>
                            <p>根據航空公司規定，您訂的機票必須依照航程順序使用。若未能依序使用，
                                則機票、燃油附加費及政府稅項，均將依據實際航程重新計算。
                                如果重新計算的金額超過您已支付的機票金額，
                                您將須支付價差。此外，機票上任何未使用的航段均將失效且無法使用。最終結果取決於營運業者。</p>
                        </div>

                    </div>

                </div>
            </div>

            <div class="row container_notice" style="padding: 20px; margin-top: 20px; ">
                <div class="col_ticket">行李限額
                    <p><span class="material-symbols-outlined" style="vertical-align: middle">checked_bag</span>手提行李：1 x
                        7 公斤</p>
                    <p><span class="material-symbols-outlined" style="vertical-align: middle;">luggage</span>托運行李：1 件
                    </p>
                </div>
                <div class="col_ticket">政策
                    <p>部分無法退款</p>
                    <p>更改費用：NT$7,352</p>
                </div>
            </div>



            <h5></h5>
            <div class="container">
                <div style="font-weight: bolder;">主要旅客資訊</div>
                <hr>
                <div id="passenger_container">
                    <div class="form_section">
                        <div>旅客1(成人票)</div>
                        <div class="container_info">

                            <form style="width: 100%; margin: 0 auto;">
                                <div style="display: grid; grid-template-columns: 50% 50%; margin-bottom: 5px;">
                                    <div>
                                        <label for="lastname">姓氏：</label>
                                        <input type="text" id="lastname" placeholder="姓氏" style="width:70% ;">

                                    </div>

                                    <div>
                                        <label for="firstname">名字：</label>
                                        <input type="text" id="firstname" placeholder="名字" style="width:70%;">
                                    </div>

                                </div>

                                <div style="display: grid; grid-template-columns: 22% 38% 40%;margin-bottom: 10px;">
                                    <div>
                                        <label for="gender">性別：</label>
                                        <select id="gender" style="width: 45%;">
                                            <option value="male">男性</option>
                                            <option value="female">女性</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="dob">出生日期：</label>
                                        <input type="date" id="dob" style="width: 55%;">
                                    </div>
                                    <div>
                                        證件號碼：<input id="idnumber" type="text" style="width:52%;">
                                    </div>


                                </div>
                                <div style="display: grid; grid-template-columns: 22% 30% 46%;">
                                    <div>
                                        <label for="">國籍：</label>
                                        <select style="width: 50%;" id="country">
                                            <option value="tw">台灣</option>
                                            <option value="us">美國</option>
                                            <option value="cn">中國</option>
                                            <option value="jp">日本</option>
                                            <option value="kr">韓國</option>
                                            <option value="fr">法國</option>
                                            <option value="de">德國</option>
                                            <option value="gb">英國</option>
                                            <option value="it">義大利</option>
                                            <option value="es">西班牙</option>
                                            <option value="in">印度</option>
                                            <option value="br">巴西</option>
                                            <option value="au">澳洲</option>
                                            <option value="ca">加拿大</option>
                                            <option value="ru">俄羅斯</option>
                                            <option value="za">南非</option>
                                            <option value="mx">墨西哥</option>
                                            <option value="ar">阿根廷</option>
                                            <option value="nl">荷蘭</option>
                                            <option value="se">瑞典</option>
                                            <option value="ch">瑞士</option>
                                            <option value="sg">新加坡</option>
                                        </select>

                                    </div>
                                    <div>
                                        證件類型：
                                        <select style="width: 40%;" id="idtype">
                                            <option value="passport">護照</option>
                                        </select>
                                    </div>

                                    <div>
                                        證件有效日期至：<input type="date" id="dop" style="width: 45%;">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <hr style="border: 1px dashed;">
                        <button class="delete_btn">刪除</button>
                    </div>

                    <div>
                        <p>一經確認即無法變更訂單。如果您的姓名不正確，您可能無法登機且將必須支付退票費用。</p>
                    </div>
                    <div style="display: flex;justify-content: center; padding: 20px">
                        <button id="add_passenger"
                            style="width: 200px; font-size: 16px; border-radius: 5px;">新增另位旅客</button>
                    </div>
                </div>

            </div>

            <div>
                <div style="margin: 5% 10% 2% 10%; font-weight: bold; font-size: 20px;">行李資訊</div>
                <div id="luggage_container">
                    <div class="luggageform_section">
                        <div style="margin: 10px auto;width: 80%;">旅客1 行李:</div>
                        <div class="container_luggage">去程(已包含的行李)</div>
                        <div class="container_lg">
                            <div class="grid_luggage">
                                <div>個人物品<br>
                                    <p style="font-size: 11px;">請聯繫航空公司了解詳細的行李尺寸規定</p>
                                </div>
                                <div>手提行李<br>(50*40*25公分)</div>
                                <div>托運行李<br>
                                    <p style="font-size: 11px;">請聯繫航空公司了解詳細的行李尺寸規定</p>
                                </div>
                            </div>

                            <div class="grid_luggage_icon">
                                <span class="material-symbols-outlined" style="font-size: 60px;">personal_bag</span>
                                <span class="material-symbols-outlined" style="font-size: 60px;">checked_bag</span>
                                <span class="material-symbols-outlined" style="font-size: 60px;">luggage</span>
                            </div>

                            <div class="grid_luggage">
                                <div>1件</div>
                                <div>1件，共7公斤</div>
                                <div>1件，共23公斤</div>
                            </div>

                            <label for="add_luggage_1">
                                <select name="addLg_1" id="add_luggage_1" class="label_addluggage">
                                    <option value="add_lg">加購行李</option>
                                    <option value="non_lg">無額外行李</option>
                                    <option value="one_lg">1件，共20公斤&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;NT$1,224
                                    </option>
                                    <option value="two_lg">2件，共40公斤&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;NT$1,698
                                    </option>
                                    <option value="three_lg">3件，共60公斤&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;NT$2,171
                                    </option>>
                                </select>
                            </label>
                        </div>

                        <div class="container_luggage">回程(已包含的行李)</div>
                        <div class="container_lg" style="margin-bottom: 5%;">
                            <div class="grid_luggage">
                                <div>個人物品<br>
                                    <p style="font-size: 11px;">請聯繫航空公司了解詳細的行李尺寸規定</p>
                                </div>
                                <div>手提行李<br>(50*40*25公分)</div>
                                <div>托運行李<br>
                                    <p style="font-size: 11px;">請聯繫航空公司了解詳細的行李尺寸規定</p>
                                </div>
                            </div>

                            <div class="grid_luggage_icon">
                                <span class="material-symbols-outlined" style="font-size: 60px;">personal_bag</span>
                                <span class="material-symbols-outlined" style="font-size: 60px;">checked_bag</span>
                                <span class="material-symbols-outlined" style="font-size: 60px;">luggage</span>
                            </div>

                            <div class="grid_luggage">
                                <div>1件</div>
                                <div>1件，共7公斤</div>
                                <div>1件，共23公斤</div>
                            </div>

                            <label for="add_luggage_2">
                                <select name="addLg_2" id="add_returnluggage_2" class="label_addluggage">
                                    <option value="add_lg">加購行李</option>
                                    <option value="non_lg">無額外行李</option>
                                    <option value="one_lg">1件，共20公斤&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;NT$1,224
                                    </option>
                                    <option value="two_lg">2件，共40公斤&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;NT$1,698
                                    </option>
                                    <option value="three_lg">3件，共60公斤&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;NT$2,171
                                    </option>
                                </select>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div>
                <h5 style="margin-left: 10%; font-size: larger;">聯繫方式</h5>
                <div class="container_contact">
                    <div><input type="text" placeholder="聯繫人姓名" class="container_contactinfo" id="contact_name"></div>
                    <div><input type="tel" placeholder="手機號碼" class="container_contactinfo" id="contact_phone">
                    </div>
                    <div><input type="email" placeholder="電子郵件" class="container_contactinfo" id="contact_email">
                    </div>

                </div>
            </div>

            <div class="container" style="width: 80%; padding: 20px;margin-top: 50px;">
                總計<br>
                <div style="display: flex;justify-content: center;">
                    <button class="style_nextstep" id="next_step">下一步</button>
                </div>
            </div>
        </div>

        <div class="col_right" style="min-height: 50vh;">
            <div class="container_right">
                <form id="booking_form">
                    <div style="font-size: 22px; margin-top: 10px">價格詳情</div>
                    <div style="margin: 5px 10px;">
                        <div style="display:flex;justify-content: space-between;">
                            <h3>機票 (2位成人)</h3>
                            <h3 id="ticket_price" name="ticket_price">NT$ 9,999</h3>
                        </div>

                        <h3 style="margin: 0; padding: 2px 0;">行李</h3>
                        <div style="display:flex;justify-content: space-between;">
                            <p>個人物品</p>
                            <p>免費</p>
                        </div>

                        <div style="display:flex;justify-content: space-between;">
                            <p>手提行李</p>
                            <p>免費</p>
                        </div>

                        <div style="display:flex;justify-content: space-between;">
                            <p>托運行李</p>
                            <p id="price_luggage">免費</p>
                        </div>

                        <hr style="border: 1px dashed; margin: 5px 0;">
                        <div style="display:flex;justify-content: space-between;">
                            <h3>總額</h3>
                            <h3 id="price_total">Total</h3>
                            <input type="hidden" id="final_price" name="final_price">
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <footer>
        <div class="search_section_container search_footer_container">
            <div class="search_footer_col">
                <h4>追蹤我們</h4>
                <hr style="width:50%">
                <div class="search_footer_socials">
                    <span>
                        <a href="#"><i class="ri-twitter-fill"></i></a>
                    </span>
                    <span>
                        <a href="#"><i class="ri-linkedin-fill"></i></a>
                    </span>
                    <span>
                        <a href="#"><i class="ri-instagram-line"></i></a>
                    </span>
                    <span>
                        <a href="#"><i class="ri-facebook-fill"></i></a>
                    </span>
                </div>
            </div>
            <div class="search_footer_col">
                <h4>隱私</h4>
                <hr style="width:80%">
                <a href="#">隱私權政策</a>
                <a href="#">隱私設定</a>
            </div>
            <div class="search_footer_col">
                <h4>Cookie</h4>
                <hr style="width:80%">
                <a href="#">Cookie政策</a>
                <a href="#">Cookie設定</a>
            </div>
            <div class="search_footer_col">
                <h4>合作夥伴</h4>
                <hr style="width:80%">
                <a href="#">廣告投放</a>
                <a href="#">旅遊宣傳合作</a>
            </div>
        </div>
        <div class="search_footer_bar">
            Copyright © 2024 Javel. All rights reserved.
        </div>
    </footer>
</body>